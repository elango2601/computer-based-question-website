<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - StudentQA</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav>
        <div class="logo">Student<span>QA</span> <span class="badge"
                style="background:var(--secondary); font-size: 0.7rem; padding: 2px 8px; border-radius: 4px;">ADMIN</span>
        </div>
        <div class="nav-links">
            <a href="#" class="active">Student Performance</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container animate-fade-in">
        <div class="flex justify-between items-center mb-8">
            <h2>Question Management</h2>
            <button onclick="toggleQuestionForm()" class="btn btn-primary">Add New Question</button>
        </div>

        <!-- Add Question Form -->
        <div id="question-form-card" class="card mb-8 hidden">
            <h3 class="mb-4">Add Question</h3>
            <div class="input-group">
                <label>Question Text</label>
                <textarea id="new-q-text" rows="2"></textarea>
            </div>
            <div class="input-group">
                <label>Category</label>
                <input type="text" id="new-q-cat" placeholder="e.g. Mathematics">
            </div>
            <div class="input-group">
                <label>Difficulty</label>
                <select id="new-q-diff">
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            </div>

            <div class="input-group">
                <label>Options (comma separated, e.g. A,B,C,D)</label>
                <input type="text" id="new-q-options" placeholder="Option 1, Option 2, Option 3, Option 4">
            </div>
            <div class="input-group">
                <label>Correct Answer (Must match one option exactly)</label>
                <input type="text" id="new-q-correct">
            </div>

            <button onclick="addQuestion()" class="btn btn-primary">Save Question</button>
        </div>

        <div class="card mb-8">
            <h3 class="mb-4">All Questions</h3>
            <div id="questions-list" style="max-height: 300px; overflow-y: auto;">
                <!-- Loaded via JS -->
            </div>
        </div>

        <div class="flex justify-between items-center mb-8">
            <h2>Student Performance</h2>
            <div class="flex gap-4">
                <button onclick="exportCSV()" class="btn btn-secondary">Export to Excel (CSV)</button>
                <button onclick="exportSQL()" class="btn btn-secondary">Export SQL</button>
            </div>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <table id="admin-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Username</th>
                        <th>Test Title</th>
                        <th>Score</th>
                        <th>Percentage</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="admin-body">
                    <!-- Loaded dynamically -->
                </tbody>
            </table>
            <div id="loading" class="text-center p-4">Loading Data...</div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        checkAuth('admin');
        let studentData = [];

        async function loadData() {
            const { status, data } = await apiCall('/admin/stats');
            if (status === 200) {
                studentData = data;
                document.getElementById('loading').classList.add('hidden');
                const tbody = document.getElementById('admin-body');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No test attempts recorded yet.</td></tr>';
                    return;
                }

                data.forEach(row => {
                    const total = row.totalQuestions || 0;
                    const percent = total > 0 ? Math.round((row.score / total) * 100) : 0;

                    let color = 'var(--text-muted)';
                    if (total > 0) {
                        if (percent >= 80) color = 'var(--success)';
                        else if (percent >= 50) color = 'var(--primary)';
                        else color = 'var(--error)';
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-sm text-muted">${row.date || '-'}</td>
                        <td style="font-weight: 500; color: white;">${row.username}</td>
                        <td>${row.testTitle}</td>
                        <td>${row.score} / ${total}</td>
                        <td style="color: ${color}; font-weight: 700;">${percent}%</td>
                        <td>
                             <button onclick="viewAnswers(${row.userId}, ${row.testId})" style="background:var(--primary); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem; margin-right:5px;">View</button>
                             <button onclick="viewAnswers(${row.userId}, ${row.testId})" style="background:var(--primary); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem; margin-right:5px;">View</button>
                             <button onclick="resetResult(${row.userId}, ${row.testId})" style="background:var(--error); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem">Reset</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function exportCSV() {
            if (!studentData.length) return showToast('No data to export', 'error');

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Username,Test Title,Score,Total Questions,Percentage (%)\n";

            studentData.forEach(row => {
                const total = row.totalQuestions || 0;
                const percent = total > 0 ? Math.round((row.score / total) * 100) : 0;
                csvContent += `${row.date},${row.username},${row.testTitle},${row.score},${total},${percent}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_performance.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportSQL() {
            if (!studentData.length) return showToast('No data to export', 'error');

            let sqlContent = "CREATE TABLE IF NOT EXISTS student_marks (date DATE, username TEXT, test_title TEXT, score INT, total INT, percentage INT);\n";
            sqlContent += "INSERT INTO student_marks VALUES \n";

            const values = studentData.map(row => {
                const total = row.totalQuestions || 0;
                const percent = total > 0 ? Math.round((row.score / total) * 100) : 0;
                return `('${row.date}', '${row.username}', '${row.testTitle}', ${row.score}, ${total}, ${percent})`;
            }).join(",\n");

            sqlContent += values + ";";

            const blob = new Blob([sqlContent], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "student_marks_export.sql";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        loadData();
        loadQuestions();

        function toggleQuestionForm() {
            document.getElementById('question-form-card').classList.toggle('hidden');
        }

        async function loadQuestions() {
            const { status, data } = await apiCall('/questions');
            const list = document.getElementById('questions-list');
            list.innerHTML = '';

            if (status === 200) {
                if (data.length === 0) list.innerHTML = '<div class="text-muted">No questions found.</div>';

                data.forEach(q => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 mb-2';
                    item.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    item.innerHTML = `
                        <div>
                            <div style="font-weight:600">${q.text}</div>
                            <div class="text-xs text-muted">Category: ${q.category} | Diff: ${q.difficulty} | Ans: ${q.correct_answer || q.correct}</div>
                        </div>
                        <button onclick="deleteQuestion(${q.id})" style="color:var(--error); border:1px solid var(--error); padding: 4px 8px; border-radius:4px; cursor:pointer; background:transparent;">Delete</button>
                     `;
                    list.appendChild(item);
                });
            }
        }

        async function addQuestion() {
            const text = document.getElementById('new-q-text').value;
            const category = document.getElementById('new-q-cat').value;
            const difficulty = document.getElementById('new-q-diff').value;
            const optionsStr = document.getElementById('new-q-options').value;
            const correct = document.getElementById('new-q-correct').value;

            if (!text || !correct) return showToast('Please fill required fields', 'error');

            const options = optionsStr ? optionsStr.split(',').map(s => s.trim()) : [];

            const res = await apiCall('/admin/questions', 'POST', {
                text, category, difficulty, options, correct_answer: correct
            });

            if (res.status === 200) {
                showToast('Question added successfully', 'info');
                document.getElementById('question-form-card').classList.add('hidden');
                // Clear inputs
                document.getElementById('new-q-text').value = '';
                document.getElementById('new-q-options').value = '';
                document.getElementById('new-q-correct').value = '';
                loadQuestions();
            } else {
                showToast('Failed to add question', 'error');
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('Are you sure you want to delete this question? This will also remove any student results associated with it.')) return;

            const res = await apiCall(`/admin/questions/${id}`, 'DELETE');
            if (res.status === 200) {
                showToast('Question deleted', 'info');
                loadQuestions();
            } else {
                showToast('Failed to delete', 'error');
            }
        }

        async function resetResult(userId, testId) {
            if (!confirm('Are you sure you want to RESET this student\'s attempt? They will be able to take the test again, and current data will be lost.')) return;

            const res = await apiCall(`/admin/reset_result/${userId}/${testId}`, 'DELETE');
            if (res.status === 200) {
                showToast('Result reset successfully', 'success');
                loadData(); // Refresh table
            } else {
                showToast('Failed to reset result', 'error');
            }
        }

        async function viewAnswers(userId, testId) {
            const { status, data } = await apiCall(`/admin/student_result/${userId}/${testId}`);
            if (status === 200) {
                showAnswersModal(data);
            } else {
                showToast(data.error || 'Failed to load answers', 'error');
            }
        }

        function showAnswersModal(data) {
            let html = '<div style="max-height:60vh; overflow-y:auto; padding-right:5px;">';
            if (data.results && data.results.length > 0) {
                data.results.forEach((r, idx) => {
                    const isCorrect = r.is_correct;
                    const color = isCorrect ? 'var(--success)' : 'var(--error)';
                    const userAns = r.user_answer || 'Not Attempted';

                    html += `
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-left: 4px solid ${color}; border-radius: 4px;">
                            <p style="margin:0 0 5px 0; font-size: 0.95rem;"><strong>Q${idx + 1}:</strong> ${r.question_text}</p>
                            <div style="font-size: 0.85rem; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>Student Answer: <span style="color:${userAns === r.correct_answer ? 'var(--success)' : 'var(--error)'}">${userAns}</span></div>
                                <div>Correct Answer: <span style="color:var(--success)">${r.correct_answer}</span></div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>No detailed answers found.</p>';
            }
            html += '</div>';

            const modal = document.createElement('div');
            modal.id = 'answers-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; justify-content:center; align-items:center; backdrop-filter: blur(5px);';
            modal.innerHTML = `
                <div style="background: #1e1e1e; padding:20px; border-radius:12px; width:90%; max-width:700px; color:var(--text-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                        <h3 style="margin:0;">Student Attempt Summary</h3>
                        <div style="text-align:right;">
                            <span style="font-size:0.9rem; color:var(--text-muted);">Score: ${data.score}/${data.total}</span>
                        </div>
                        <button onclick="document.getElementById('answers-modal').remove()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer; margin-left: 15px;">&times;</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>

</html>