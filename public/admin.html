<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - StudentQA</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <nav>
        <div class="logo">Student<span>QA</span> <span class="badge"
                style="background:var(--secondary); font-size: 0.7rem; padding: 2px 8px; border-radius: 4px;">ADMIN</span>
        </div>
        <div class="nav-links">
            <a href="#" class="active">Student Performance</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <!-- Reset Confirmation Modal -->
    <div id="reset-modal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center;">
        <div class="card"
            style="width:400px; text-align:center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid var(--border);">
            <div style="margin-bottom:15px; color:var(--error); font-size:3rem;">‚ö†Ô∏è</div>
            <h3 class="mb-4">Reset Student Data?</h3>
            <p class="mb-6 text-muted">This will permanently delete the student's exam attempt. They will be able to
                take the test again.</p>
            <div class="flex justify-center gap-4">
                <button class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
                <button class="btn btn-primary" id="confirm-reset-btn" onclick="confirmForceReset()"
                    style="background: var(--error); border-color: var(--error);">Yes, Reset Data</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:none; justify-content:center; align-items:center; backdrop-filter: blur(5px);">
        <div
            style="background:#1e293b; padding:25px; border-radius:16px; width:90%; max-width:400px; text-align:center; border:1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div>
            <h3 class="mb-2" style="color:white; font-size:1.5rem;">Confirm Action</h3>
            <p class="mb-6" style="color:#94a3b8; font-size:1rem;" id="confirm-msg">Are you sure?</p>
            <div style="display:flex; justify-content:center; gap:15px;">
                <button onclick="closeConfirmModal()" class="btn"
                    style="background:transparent; border:1px solid #334155; color:#cbd5e1; padding: 8px 16px;">Cancel</button>
                <button id="confirm-yes-btn" class="btn"
                    style="background:#ef4444; color:white; border:none; padding: 8px 16px; font-weight:600;">Yes,
                    Delete</button>
            </div>
        </div>
    </div>

    <div class="container animate-fade-in">
        <!-- Test Management Section -->
        <div class="flex justify-between items-center mb-8">
            <h2>Test Management</h2>
            <button onclick="toggleTestForm()" class="btn btn-primary">Create New Test</button>
        </div>

        <!-- Add Test Form -->
        <div id="test-form-card" class="card mb-8 hidden">
            <h3 class="mb-4" id="test-form-title">Create Test</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group">
                    <label>Title <span style="color:red">*</span></label>
                    <input type="text" id="new-test-title" placeholder="e.g. Science Final Exam">
                </div>
                <div class="input-group">
                    <label>Date <span style="color:red">*</span></label>
                    <input type="date" id="new-test-date">
                </div>
                <div class="input-group">
                    <label>Duration (Minutes)</label>
                    <input type="number" id="new-test-duration" value="60">
                </div>
                <div class="input-group">
                    <label>Online Compiler?</label>
                    <select id="new-test-compiler">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
            </div>
            <div class="input-group">
                <label>Description</label>
                <textarea id="new-test-desc" rows="2" placeholder="Brief description..."></textarea>
            </div>
            <div class="flex gap-4">
                <button onclick="toggleTestForm()" class="btn btn-secondary w-full">Cancel</button>
                <button onclick="saveTest()" id="test-submit-btn" class="btn"
                    style="background:var(--success); width:100%;">Create Test</button>
            </div>
        </div>

        <!-- Tests List -->
        <div id="tests-admin-list" class="card mb-12">
            Loading tests...
        </div>

        <div class="flex justify-between items-center mb-8">
            <h2>Question Management</h2>
            <button onclick="toggleQuestionForm()" class="btn btn-primary">Add New Question</button>
        </div>

        <!-- Add Question Form -->
        <div id="question-form-card" class="card mb-8 hidden">
            <h3 class="mb-4">Add Question</h3>
            <div class="input-group">
                <label>Select Test/Phase <span style="color:red">*</span></label>
                <select id="new-q-test">
                    <option value="">Loading...</option>
                </select>
            </div>

            <div class="input-group">
                <label>Question Text</label>
                <textarea id="new-q-text" rows="2"></textarea>
            </div>
            <div class="input-group">
                <label>Category</label>
                <input type="text" id="new-q-cat" placeholder="e.g. Mathematics">
            </div>
            <div class="input-group">
                <label>Difficulty</label>
                <select id="new-q-diff">
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            </div>

            <div class="input-group">
                <label>Options (comma separated, e.g. A,B,C,D)</label>
                <input type="text" id="new-q-options" placeholder="Option 1, Option 2, Option 3, Option 4">
            </div>
            <div class="input-group">
                <label>Correct Answer (Must match one option exactly)</label>
                <input type="text" id="new-q-correct">
            </div>

            <button onclick="addQuestion()" class="btn btn-primary">Save Question</button>
        </div>

        <div class="card mb-8">
            <h3 class="mb-4">All Questions</h3>
            <div id="questions-list" style="max-height: 300px; overflow-y: auto;">
                <!-- Loaded via JS -->
            </div>
        </div>

        <div class="flex justify-between items-center mb-8">
            <h2>Student Performance</h2>
            <div class="flex gap-4">
                <button onclick="exportCSV()" class="btn btn-secondary">Export to Excel (CSV)</button>
                <button onclick="exportSQL()" class="btn btn-secondary">Export SQL</button>
            </div>
        </div>

        <!-- Analytics Chart -->
        <div class="card mb-8">
            <h3 class="mb-4">üìà Overall Performance Analysis</h3>
            <div style="position: relative; height:400px; width:100%">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <table id="admin-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Username</th>
                        <th>Test Title</th>
                        <th>Score</th>
                        <th>Percentage</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="admin-body">
                    <!-- Loaded dynamically -->
                </tbody>
            </table>
            <div id="loading" class="text-center p-4">Loading Data...</div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        checkAuth('admin');
        let studentData = [];
        let resultToReset = null;

        async function loadData() {
            const { status, data } = await apiCall('/admin/stats');
            if (status === 200) {
                studentData = data;
                document.getElementById('loading').classList.add('hidden');

                // Render Chart
                renderChart(data);

                const tbody = document.getElementById('admin-body');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No test attempts recorded yet.</td></tr>';
                    return;
                }

                data.forEach(row => {
                    const total = row.totalQuestions || 0;
                    const percent = total > 0 ? Math.round((row.score / total) * 100) : 0;

                    let color = 'var(--text-muted)';
                    if (total > 0) {
                        if (percent >= 80) color = 'var(--success)';
                        else if (percent >= 50) color = 'var(--primary)';
                        else color = 'var(--error)';
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-sm text-muted">${row.date || '-'}</td>
                        <td style="font-weight: 500; color: white;">${row.username}</td>
                        <td>${row.testTitle}</td>
                        <td>${row.score} / ${total}</td>
                        <td style="color: ${color}; font-weight: 700;">${percent}%</td>
                        <td>
                            <button onclick="viewAnswers(${row.userId}, ${row.testId})" style="background:var(--primary); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem; margin-right:5px;">View</button>
                             <button onclick="resetResult(${row.userId}, ${row.testId})" style="background:var(--error); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem">Reset</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        let chartInstance = null;

        function renderChart(data) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            // X-Axis: Student Names
            // Datasets: Tests

            const studentsSet = new Set();
            const testsSet = new Set();
            const scoresMap = {}; // Key: TestName, Value: { StudentName: Score }

            data.forEach(d => {
                studentsSet.add(d.username);
                testsSet.add(d.testTitle);

                if (!scoresMap[d.testTitle]) scoresMap[d.testTitle] = {};
                scoresMap[d.testTitle][d.username] = d.score; // Raw Score
            });

            const studentLabels = Array.from(studentsSet).sort();
            const testLabels = Array.from(testsSet);

            const colors = ['#6366f1', '#22c55e', '#ef4444', '#eab308', '#ec4899', '#8b5cf6'];

            const datasets = testLabels.map((testName, idx) => {
                const color = colors[idx % colors.length];
                return {
                    label: testName,
                    data: studentLabels.map(student => scoresMap[testName][student] !== undefined ? scoresMap[testName][student] : 0),
                    backgroundColor: color,
                    borderRadius: 4,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                };
            });

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: studentLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 60, // User requested reference to 60 marks
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' },
                            title: { display: true, text: 'Score (Marks)', color: '#6b7280' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' },
                            title: { display: true, text: 'Students', color: '#6b7280' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'white' },
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }

        function exportCSV() {
            if (!studentData.length) return showToast('No data to export', 'error');

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Username,Test Title,Score,Total Questions,Percentage (%)\n";

            studentData.forEach(row => {
                const total = row.totalQuestions || 0;
                const percent = total > 0 ? Math.round((row.score / total) * 100) : 0;
                csvContent += `${row.date},${row.username},${row.testTitle},${row.score},${total},${percent}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_performance.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportSQL() {
            if (!studentData.length) return showToast('No data to export', 'error');

            let sqlContent = "CREATE TABLE IF NOT EXISTS student_marks (date DATE, username TEXT, test_title TEXT, score INT, total INT, percentage INT);\n";
            sqlContent += "INSERT INTO student_marks VALUES \n";

            const values = studentData.map(row => {
                const total = row.totalQuestions || 0;
                const percent = total > 0 ? Math.round((row.score / total) * 100) : 0;
                return `('${row.date}', '${row.username}', '${row.testTitle}', ${row.score}, ${total}, ${percent})`;
            }).join(",\n");

            sqlContent += values + ";";

            const blob = new Blob([sqlContent], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "student_marks_export.sql";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        loadData();
        loadQuestions();
        loadTestsForForm();
        loadTestsList();

        function toggleQuestionForm() {
            document.getElementById('question-form-card').classList.toggle('hidden');
        }

        let allTests = [];
        let editingTestId = null;

        function toggleTestForm(reset = true) {
            const card = document.getElementById('test-form-card');
            if (reset && card.classList.contains('hidden')) {
                // Determine if we are opening fresh
                resetForm();
            }
            card.classList.toggle('hidden');
        }

        function resetForm() {
            editingTestId = null;
            document.getElementById('test-form-title').innerText = 'Create Test';
            document.getElementById('test-submit-btn').innerText = 'Create Test';
            document.getElementById('new-test-title').value = '';
            document.getElementById('new-test-date').value = '';
            document.getElementById('new-test-duration').value = '60';
            document.getElementById('new-test-desc').value = '';
            document.getElementById('new-test-compiler').value = 'false';
        }

        function editTest(id) {
            const t = allTests.find(x => x.id === id);
            if (!t) return;

            editingTestId = id;
            document.getElementById('test-form-title').innerText = 'Edit Test';
            document.getElementById('test-submit-btn').innerText = 'Update Test';

            document.getElementById('new-test-title').value = t.title;
            document.getElementById('new-test-date').value = t.scheduled_date; // Ensure YYYY-MM-DD format
            document.getElementById('new-test-duration').value = t.duration_minutes;
            document.getElementById('new-test-desc').value = t.description || '';
            // Checking if has_compiler exists or default
            // t.has_compiler might not be in get_tests response?
            // User can define logic for compiler option if needed

            document.getElementById('test-form-card').classList.remove('hidden');
            window.scrollTo({ top: 100, behavior: 'smooth' });
        }

        async function loadTestsList() {
            // Re-use /api/tests public endpoint for list
            const { status, data } = await apiCall('/tests');
            const list = document.getElementById('tests-admin-list');
            list.innerHTML = '';

            if (status === 200 && data.length > 0) {
                allTests = data; // Store for editing

                // Table header
                const header = document.createElement('div');
                header.className = 'flex justify-between p-2 text-muted text-sm';
                header.innerHTML = '<span>Title & Status</span><span>Actions</span>';
                list.appendChild(header);

                data.forEach(t => {
                    const isActive = t.is_active !== false;
                    const statusColor = isActive ? 'var(--success)' : 'var(--error)';
                    const statusText = isActive ? 'Active' : 'Expired';
                    const toggleLabel = isActive ? 'Expire' : 'Activate';
                    const toggleClass = isActive ? 'btn-secondary' : 'btn-success';

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 mb-2';
                    item.style.background = 'rgba(255,255,255,0.05)';
                    item.style.borderRadius = '8px';
                    item.innerHTML = `
                        <div>
                            <div style="font-weight:600">
                                ${t.title} 
                                <span style="font-size:0.7rem; background:${statusColor}; color:#000; padding:2px 6px; border-radius:4px; margin-left:5px;">${statusText}</span>
                            </div>
                            <div class="text-xs text-muted">${t.scheduled_date} | ${t.duration_minutes}m | ${t.total_questions} Questions</div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="editTest(${t.id})" style="font-size:0.8rem; padding: 4px 10px; border-radius:4px; cursor:pointer;" class="btn-primary">Edit</button>
                             <button onclick="toggleTestStatus(${t.id})" style="font-size:0.8rem; padding: 4px 10px; border-radius:4px; cursor:pointer;" class="${toggleClass}">${toggleLabel}</button>
                             <button onclick="deleteTest(${t.id})" style="color:var(--error); border:1px solid var(--error); padding: 4px 12px; border-radius:4px; cursor:pointer; background:transparent;">Delete</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<div class="text-muted text-center">No tests found. Create one!</div>';
            }
        }

        async function saveTest() {
            const title = document.getElementById('new-test-title').value;
            const date = document.getElementById('new-test-date').value;
            const duration = document.getElementById('new-test-duration').value;
            const compiler = document.getElementById('new-test-compiler').value === 'true';
            const desc = document.getElementById('new-test-desc').value;

            if (!title || !date) return showToast('Title and Date are required', 'error');

            let res;
            if (editingTestId) {
                // Update
                res = await apiCall(`/admin/tests/${editingTestId}/update`, 'PUT', {
                    title, scheduled_date: date, duration_minutes: duration, has_compiler: compiler, description: desc
                });
            } else {
                // Create
                res = await apiCall('/admin/tests', 'POST', {
                    title, scheduled_date: date, duration_minutes: duration, has_compiler: compiler, description: desc
                });
            }

            if (res.status === 200) {
                showToast(editingTestId ? 'Test updated' : 'Test created', 'success');
                if (!editingTestId) toggleTestForm(); // Close if create, keep open if edit? Or close both.
                if (editingTestId) document.getElementById('test-form-card').classList.add('hidden');

                resetForm();
                loadTestsList();
                loadTestsForForm();
            } else {
                showToast(res.data.error || 'Failed to save test', 'error');
            }
        }

        async function toggleTestStatus(id) {
            const res = await apiCall(`/admin/tests/${id}/toggle`, 'POST');
            if (res.status === 200) {
                showToast(res.data.message, 'info');
                loadTestsList();
            } else {
                showToast('Failed to change status', 'error');
            }
        }

        async function deleteTest(id) {
            showConfirm('Are you sure? This deletes the test AND all its questions/results.', async () => {
                const res = await apiCall(`/admin/tests/${id}`, 'DELETE');
                if (res.status === 200) {
                    showToast('Test deleted', 'info');
                    loadTestsList();
                    loadTestsForForm();
                } else {
                    showToast('Failed to delete test', 'error');
                }
            });
        }

        async function loadTestsForForm() {
            const { status, data } = await apiCall('/tests');
            const select = document.getElementById('new-q-test');
            select.innerHTML = '<option value="">-- Select Test --</option>';

            if (status === 200 && data.length > 0) {
                data.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.innerText = t.title;
                    select.appendChild(opt);
                });
            } else {
                select.innerHTML = '<option value="">No tests found</option>';
            }
        }

        async function loadQuestions() {
            const { status, data } = await apiCall('/admin/questions'); // Use new endpoint
            const list = document.getElementById('questions-list');
            list.innerHTML = '';

            if (status === 200) {
                if (data.length === 0) list.innerHTML = '<div class="text-muted">No questions found.</div>';

                data.forEach(q => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 mb-2';
                    item.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    item.innerHTML = `
                        <div>
                            <div style="font-weight:600">${q.text}</div>
                            <div class="text-xs text-muted">Category: ${q.category} | Diff: ${q.difficulty} | Ans: ${q.correct_answer || q.correct}</div>
                        </div>
                        <button onclick="deleteQuestion(${q.id})" style="color:var(--error); border:1px solid var(--error); padding: 4px 8px; border-radius:4px; cursor:pointer; background:transparent;">Delete</button>
                     `;
                    list.appendChild(item);
                });
            }
        }

        async function addQuestion() {
            const testId = document.getElementById('new-q-test').value;
            const text = document.getElementById('new-q-text').value;
            const category = document.getElementById('new-q-cat').value;
            const difficulty = document.getElementById('new-q-diff').value;
            const optionsStr = document.getElementById('new-q-options').value;
            const correct = document.getElementById('new-q-correct').value;

            if (!testId) return showToast('Please select a test', 'error');
            if (!text || !correct) return showToast('Please fill required fields', 'error');

            const options = optionsStr ? optionsStr.split(',').map(s => s.trim()) : [];

            const res = await apiCall('/admin/questions', 'POST', {
                testId, text, category, difficulty, options, correct_answer: correct
            });

            if (res.status === 200) {
                showToast('Question added successfully', 'info');
                document.getElementById('question-form-card').classList.add('hidden');
                // Clear inputs
                document.getElementById('new-q-text').value = '';
                document.getElementById('new-q-options').value = '';
                document.getElementById('new-q-correct').value = '';
                // Reload questions (and maybe filter by test?)
                loadQuestions();
            } else {
                showToast(res.data.error || 'Failed to add question', 'error');
            }
        }

        let pendingAction = null;

        function showConfirm(msg, callback) {
            document.getElementById('confirm-msg').innerText = msg;
            pendingAction = callback;
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            pendingAction = null;
        }

        document.getElementById('confirm-yes-btn').onclick = () => {
            if (pendingAction) pendingAction();
            closeConfirmModal();
        };

        async function deleteQuestion(id) {
            showConfirm('Are you sure you want to delete this question? This will also remove any student results associated with it.', async () => {
                const res = await apiCall(`/admin/questions/${id}`, 'DELETE');
                if (res.status === 200) {
                    showToast('Question deleted', 'info');
                    loadQuestions();
                } else {
                    showToast('Failed to delete', 'error');
                }
            });
        }

        function resetResult(userId, testId) {
            resultToReset = { userId, testId };
            const modal = document.getElementById('reset-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeResetModal() {
            const modal = document.getElementById('reset-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            resultToReset = null;
        }

        async function confirmForceReset() {
            if (!resultToReset) return;

            const { userId, testId } = resultToReset;

            // UI Feedback
            const btn = document.getElementById('confirm-reset-btn');
            const originalText = btn.innerText;
            btn.innerText = 'Resetting...';
            btn.disabled = true;

            const res = await apiCall(`/admin/reset_result/${userId}/${testId}`, 'DELETE');

            if (res.status === 200) {
                showToast('Result reset successfully', 'success');
                loadData();
            } else {
                showToast('Failed to reset result', 'error');
            }

            // Reset UI
            btn.innerText = originalText;
            btn.disabled = false;
            closeResetModal();
        }

        async function viewAnswers(userId, testId) {
            const { status, data } = await apiCall(`/admin/student_result/${userId}/${testId}`);
            if (status === 200) {
                showAnswersModal(data);
            } else {
                showToast(data.error || 'Failed to load answers', 'error');
            }
        }

        function showAnswersModal(data) {
            let html = '<div style="max-height:60vh; overflow-y:auto; padding-right:5px;">';
            if (data.results && data.results.length > 0) {
                data.results.forEach((r, idx) => {
                    const isCorrect = r.is_correct;
                    const color = isCorrect ? 'var(--success)' : 'var(--error)';
                    const userAns = r.user_answer || 'Not Attempted';

                    html += `
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-left: 4px solid ${color}; border-radius: 4px;">
                            <p style="margin:0 0 5px 0; font-size: 0.95rem;"><strong>Q${idx + 1}:</strong> ${r.question_text}</p>
                            <div style="font-size: 0.85rem; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>Student Answer: <span style="color:${userAns === r.correct_answer ? 'var(--success)' : 'var(--error)'}">${userAns}</span></div>
                                <div>Correct Answer: <span style="color:var(--success)">${r.correct_answer}</span></div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>No detailed answers found.</p>';
            }
            html += '</div>';

            const modal = document.createElement('div');
            modal.id = 'answers-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; justify-content:center; align-items:center; backdrop-filter: blur(5px);';
            modal.innerHTML = `
                <div style="background: #1e1e1e; padding:20px; border-radius:12px; width:90%; max-width:700px; color:var(--text-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                        <h3 style="margin:0;">Student Attempt Summary</h3>
                        <div style="text-align:right;">
                            <span style="font-size:0.9rem; color:var(--text-muted);">Score: ${data.score}/${data.total}</span>
                        </div>
                        <button onclick="document.getElementById('answers-modal').remove()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer; margin-left: 15px;">&times;</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>

</html>