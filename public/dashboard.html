<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - StudentQA</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav>
        <div class="logo">Student<span>QA</span></div>
        <div class="nav-links">
            <span id="user-display">User</span>
            <a href="#" class="active">Dashboard</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container animate-fade-in">
        <h2 class="mb-4">Available Exams</h2>
        <div id="tests-grid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            <!-- Tests loaded dynamically -->
            <div class="text-center p-8" style="grid-column: 1/-1;">Loading available exams...</div>
        </div>

        <h2 class="mt-12 mb-4">Exam History</h2>
        <div class="card p-0 overflow-hidden">
            <table style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.05);">
                        <th style="text-align: left; padding: 1rem;">Date</th>
                        <th style="text-align: left; padding: 1rem;">Exam Name</th>
                        <th style="text-align: center; padding: 1rem;">Score</th>
                        <th style="text-align: center; padding: 1rem;">Percentage</th>
                        <th style="text-align: right; padding: 1rem;">Action</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr>
                        <td colspan="5" class="text-center p-4 text-muted">No completed exams found.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        checkAuth('student');

        async function loadTests() {
            const { status, data } = await apiCall('/tests');
            const grid = document.getElementById('tests-grid');
            const historyBody = document.getElementById('history-body');

            grid.innerHTML = '';

            if (status === 200) {
                if (data.length === 0) {
                    grid.innerHTML = '<div class="text-center text-muted" style="grid-column: 1/-1">No exams scheduled.</div>';
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                let hasHistory = false;
                historyBody.innerHTML = '';

                data.forEach(test => {
                    const scheduledDate = test.scheduled_date; // YYYY-MM-DD

                    // 1. Available Exams Grid
                    // If not completed and date >= today (or past but still active/unattempted)
                    // Actually, let's show all upcoming or active tests in grid.
                    // If completed, maybe still show but with "View Results"

                    const card = document.createElement('div');
                    card.className = 'card test-card';
                    card.style.display = 'flex';
                    card.style.flexDirection = 'column';

                    let statusBadge = '';
                    let actionButton = '';

                    // Logic for test availability
                    if (scheduledDate > today) {
                        statusBadge = '<span style="background:var(--warning); color:black; padding:2px 8px; border-radius:4px; font-size:0.8rem">Upcoming</span>';
                        actionButton = `<button class="btn btn-secondary" disabled style="opacity:0.5; width:100%">Available on ${scheduledDate}</button>`;
                    } else if (scheduledDate < today && !test.is_completed) {
                        statusBadge = '<span style="background:var(--error); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem">Expired</span>';
                        actionButton = `<button class="btn btn-secondary" disabled style="opacity:0.5; width:100%">Exam Expired</button>`;
                    } else if (test.is_completed) {
                        statusBadge = '<span style="background:var(--success); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem">Completed</span>';
                        actionButton = `<a href="solution.html?id=${test.id}" class="btn btn-secondary" style="width:100%">View Solutions</a>
                                         <div class="text-center mt-2 text-sm">Score: ${test.score}/${test.total_questions}</div>`;

                        // Add to History
                        hasHistory = true;
                        const percent = test.total_questions > 0 ? Math.round((test.score / test.total_questions) * 100) : 0;
                        let color = 'var(--text-muted)';
                        if (percent >= 80) color = 'var(--success)';
                        else if (percent >= 50) color = 'var(--primary)';
                        else color = 'var(--error)';

                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        row.innerHTML = `
                            <td style="padding: 1rem;"><span class="text-muted text-sm">${test.scheduled_date}</span></td>
                            <td style="padding: 1rem; font-weight: 500;">${test.title}</td>
                            <td style="padding: 1rem; text-align: center;">${test.score} / ${test.total_questions}</td>
                            <td style="padding: 1rem; text-align: center; color: ${color}; font-weight: 700;">${percent}%</td>
                            <td style="padding: 1rem; text-align: right;">
                                <a href="solution.html?id=${test.id}" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">View Analysis &rarr;</a>
                            </td>
                        `;
                        historyBody.appendChild(row);

                    } else {
                        statusBadge = '<span style="background:var(--primary); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem">Active</span>';
                        actionButton = `<a href="quiz.html?id=${test.id}" class="btn btn-primary" style="width:100%">Start Exam</a>`;
                    }

                    // Always add to grid (or maybe only if not completed? User preference. Let's keep all for now so they can access solutions via grid too)
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 style="margin:0">${test.title}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-muted mb-4 text-sm" style="flex-grow:1">${test.description}</p>
                        <div class="text-xs text-muted mb-4">
                            üìÖ Date: ${test.scheduled_date} <br>
                            ‚è∞ Duration: ${test.duration_minutes} mins
                        </div>
                        <div class="mt-auto">
                            ${actionButton}
                        </div>
                    `;
                    grid.appendChild(card);
                });

                if (!hasHistory) {
                    historyBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No completed exams found yet.</td></tr>';
                }
            }
        }

        loadTests();
    </script>
</body>

</html>