<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - StudentQA</title>
    <title>Dashboard - StudentQA</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <nav>
        <div class="logo">Student<span>QA</span></div>
        <div class="nav-links">
            <span id="user-display">User</span>
            <a href="#" class="active">Dashboard</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container animate-fade-in">
        <div class="card mb-8">
            <h2 class="text-xl font-bold mb-4">üìà Performance Analytics</h2>
            <div style="height: 300px; width: 100%;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Available Exams</h2>
            <div id="tests-grid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                <!-- Tests loaded dynamically -->
                <div class="text-center p-8" style="grid-column: 1/-1;">Loading available exams...</div>
            </div>
        </div>

        <h2 class="mt-12 mb-4">Exam History</h2>
        <div class="card p-0 overflow-hidden">
            <table style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.05);">
                        <th style="text-align: left; padding: 1rem;">Date</th>
                        <th style="text-align: left; padding: 1rem;">Exam Name</th>
                        <th style="text-align: center; padding: 1rem;">Score</th>
                        <th style="text-align: center; padding: 1rem;">Percentage</th>
                        <th style="text-align: right; padding: 1rem;">Action</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr>
                        <td colspan="5" class="text-center p-4 text-muted">No completed exams found.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        checkAuth('student');

        async function loadTests() {
            const { status, data } = await apiCall('/tests');
            const grid = document.getElementById('tests-grid');
            const historyBody = document.getElementById('history-body');

            grid.innerHTML = '';

            if (status === 200) {
                if (data.length === 0) {
                    grid.innerHTML = '<div class="text-center text-muted" style="grid-column: 1/-1">No exams scheduled.</div>';
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                let hasHistory = false;
                historyBody.innerHTML = '';

                data.forEach(test => {
                    const scheduledDate = test.scheduled_date; // YYYY-MM-DD

                    const card = document.createElement('div');
                    card.className = 'card test-card';
                    card.style.display = 'flex';
                    card.style.flexDirection = 'column';

                    let statusBadge = '';
                    let actionButton = '';

                    // Logic for test availability
                    if (scheduledDate > today) {
                        statusBadge = '<span style="background:var(--warning); color:black; padding:2px 8px; border-radius:4px; font-size:0.8rem">Upcoming</span>';
                        actionButton = `<button class="btn btn-secondary" disabled style="opacity:0.5; width:100%">Available on ${scheduledDate}</button>`;
                    } else if (scheduledDate < today && !test.is_completed) {
                        statusBadge = '<span style="background:var(--error); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem">Expired</span>';
                        actionButton = `<button class="btn btn-secondary" disabled style="opacity:0.5; width:100%">Exam Expired</button>`;
                    } else if (test.is_completed) {
                        statusBadge = '<span style="background:var(--success); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem">Completed</span>';
                        const cardPercent = test.total_questions > 0 ? Math.round((test.score / test.total_questions) * 100) : 0;

                        let certBtn = '';
                        if (cardPercent >= 50) { // Assuming 50% is the passing mark for a certificate
                            certBtn = `<a href="/api/tests/${test.id}/certificate" target="_blank" class="btn btn-secondary" style="font-size:0.8rem; padding:5px 10px; margin-left:10px;">üìú Certificate</a>`;
                        }

                        actionButton = `<a href="solution.html?id=${test.id}" class="btn btn-secondary" style="width:100%">View Solutions</a>
                                         <div class="text-center mt-2 text-sm">Score: ${test.score}/${test.total_questions} (${cardPercent}%)</div>
                                         <div class="text-center mt-2">${certBtn}</div>`;

                        // Add to History
                        hasHistory = true;
                        const percent = test.total_questions > 0 ? Math.round((test.score / test.total_questions) * 100) : 0;
                        let color = 'var(--text-muted)';
                        if (percent >= 80) color = 'var(--success)';
                        else if (percent >= 50) color = 'var(--primary)';
                        else color = 'var(--error)';

                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        row.innerHTML = `
                            <td style="padding: 1rem;"><span class="text-muted text-sm">${test.scheduled_date}</span></td>
                            <td style="padding: 1rem; font-weight: 500;">${test.title}</td>
                            <td style="padding: 1rem; text-align: center;">${test.score} / ${test.total_questions}</td>
                            <td style="padding: 1rem; text-align: center; color: ${color}; font-weight: 700;">${percent}%</td>
                            <td style="padding: 1rem; text-align: right;">
                                <a href="solution.html?id=${test.id}" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">View Analysis &rarr;</a>
                                ${certBtn ? `<a href="/api/tests/${test.id}/certificate" target="_blank" style="color: var(--secondary); text-decoration: none; font-size: 0.9rem; margin-left: 10px;">üìú Certificate</a>` : ''}
                            </td>
                        `;
                        historyBody.appendChild(row);

                    } else {
                        statusBadge = '<span style="background:var(--primary); color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem">Active</span>';
                        actionButton = `<a href="quiz.html?id=${test.id}" class="btn btn-primary" style="width:100%">Start Exam</a>`;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 style="margin:0">${test.title}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-muted mb-4 text-sm" style="flex-grow:1">${test.description}</p>
                        <div class="text-xs text-muted mb-4">
                            üìÖ Date: ${test.scheduled_date} <br>
                            ‚è∞ Duration: ${test.duration_minutes} mins
                        </div>
                        <div class="mt-auto">
                            ${actionButton}
                        </div>
                    `;
                    grid.appendChild(card);
                });

                if (!hasHistory) {
                    historyBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No completed exams found yet.</td></tr>';
                }
            }
            renderChart(); // Call renderChart after tests are loaded
        }

        async function loadAnalytics() {
            // This function is now redundant as renderChart handles analytics loading
            // Keeping it for now, but its content is moved to renderChart
        }

        loadTests();
        loadAnalytics(); // This will effectively do nothing now, but keeping the call for consistency if other parts rely on it.

        async function renderChart() {
            const { status, data } = await apiCall('/user/analytics');
            if (status !== 200 || !data || data.length === 0) {
                document.getElementById('performanceChart').parentElement.innerHTML = '<p class="text-muted text-center">Complete an exam to see analytics.</p>';
                return;
            }

            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.test_title),
                    datasets: [{
                        label: 'Score Percentage (%)',
                        data: data.map(d => d.percentage),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white' } },
                        x: { grid: { display: false }, ticks: { color: 'white' } }
                    },
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    }
                }
            });
        }
    </script>
</body>

</html>